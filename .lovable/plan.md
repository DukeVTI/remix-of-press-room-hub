

# Birthday and Account Anniversary Celebration Feature

## What This Does

Per the PRP brief, when it's a user's birthday or account creation anniversary, the system automatically creates a celebratory post that appears on the homepage of their blog accounts for 24 hours. Followers also get notified.

---

## What Already Exists

- The `celebration_posts` database table is ready with `birthday` and `account_anniversary` types, `active`/`expired` statuses, and an `expires_at` timestamp
- Birthday (month + day) is already stored in `profiles.date_of_birth`
- Account creation date is in `profiles.created_at`

## What Needs to Be Built

### 1. Edge Function: `check-celebrations`

A backend function that:
- Queries all profiles where today's month/day matches their `date_of_birth` (birthday) or `created_at` (anniversary)
- For each match, finds all their blog accounts
- Creates a `celebration_posts` entry for each blog with a warm, branded message (24-hour expiry)
- Also expires any old celebration posts that have passed their `expires_at`
- Sends a notification email to the account owner via Resend (branded, witty)

This function will be designed to be called daily (manually or via an external cron service like cron-job.org pointing at the function URL).

### 2. Edge Function: `send-celebration-email`

Sends branded celebration emails via Resend:
- **Birthday**: Warm birthday greeting with PRP branding
- **Anniversary**: Congratulations on their PRP membership anniversary

Sender: `noreply@prp.broadcasterscommunity.com`

### 3. Frontend: Celebration Banner on Blog View

On `BlogView.tsx`, query `celebration_posts` for the current blog. If an active celebration exists, display a festive banner at the top of the blog page:
- Birthday: cake icon, confetti-style accent, "It's [Publisher]'s birthday today!"
- Anniversary: sparkle icon, "Celebrating [X] year(s) on Press Room Publisher!"

The banner is visible to all visitors for 24 hours.

### 4. Frontend: Celebration Banner on Dashboard

On `Dashboard.tsx`, if the logged-in user has an active birthday or anniversary celebration, show a personal celebratory card in the hero section.

### 5. Database: Expire Old Celebrations

The `check-celebrations` edge function will also run an UPDATE to set `status = 'expired'` on any `celebration_posts` where `expires_at < now()`.

---

## Technical Details

### Edge Function: `check-celebrations`

```text
supabase/functions/check-celebrations/index.ts
```

Logic:
1. Use service role key to query all profiles
2. Extract today's month/day
3. Find birthday matches: `EXTRACT(MONTH FROM date_of_birth) = current_month AND EXTRACT(DAY FROM date_of_birth) = current_day`
4. Find anniversary matches: same logic on `created_at`
5. Check no duplicate celebration already exists for today
6. Create celebration_posts entries with `expires_at = now() + 24 hours`
7. Call `send-celebration-email` for each celebrant
8. Expire old posts: `UPDATE celebration_posts SET status = 'expired' WHERE expires_at < now() AND status = 'active'`

### Celebration Post Content (generated by the function)

**Birthday message:**
"Happy Birthday, [First Name]! The entire Press Room Publisher community celebrates with you today. May your stories continue to inspire, inform, and ignite change. Here's to another remarkable year of impactful publishing!"

**Anniversary message:**
"Congratulations, [First Name]! Today marks [N] year(s) since you joined Press Room Publisher. Your voice matters, your stories count, and your contributions make the world a better-informed place. Thank you for being part of the PRP family!"

### Frontend Component: `CelebrationBanner.tsx`

A reusable component that:
- Takes a `blogId` prop
- Queries `celebration_posts` where `blog_id = blogId`, `status = 'active'`, and `expires_at > now()`
- Renders a themed banner (birthday or anniversary)
- Fully accessible with alt text and ARIA labels

### Files to Create
- `supabase/functions/check-celebrations/index.ts` -- daily celebration checker
- `supabase/functions/send-celebration-email/index.ts` -- branded email sender
- `src/components/CelebrationBanner.tsx` -- frontend banner component

### Files to Modify
- `src/pages/BlogView.tsx` -- add CelebrationBanner above the posts section
- `src/pages/Dashboard.tsx` -- add personal celebration card in hero
- `supabase/config.toml` -- add `verify_jwt = false` for `check-celebrations`

### Scheduling

Since Lovable Cloud doesn't support native cron jobs, the `check-celebrations` function will be a publicly callable endpoint. You can set up a free external cron service (like cron-job.org) to call it once daily, or trigger it manually. The function is idempotent -- calling it multiple times on the same day won't create duplicate celebrations.

